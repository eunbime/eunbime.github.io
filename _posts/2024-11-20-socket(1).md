---
title: Socketì„ ì‚¬ìš©í•œ Read-Time ì±„íŒ… êµ¬í˜„í•˜ê¸° - (1) Socket IO ì´ˆê¸° ì„¸íŒ…
date: 2024-11-21 07:20:30 +09:00
categories: [í”„ë¡ íŠ¸ì—”ë“œ, Next.js]
tags: [Next.js, Socket]
---

# ğŸ‘©â€ğŸ’» Socketì„ ì‚¬ìš©í•œ Real-Time ì±„íŒ… êµ¬í˜„í•˜ê¸°

<br />

## 1ï¸âƒ£ Socket IO ì´ˆê¸° ì„¸íŒ…

### 1. Socket íŒ¨í‚¤ì§€ ì„¤ì¹˜

---

ë¨¼ì € ì†Œì¼“ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ í•„ìš”í•œ íŒ¨í‚¤ì§€ë“¤ì„ ì„¤ì¹˜í•´ì¤€ë‹¤.

```json
"socket.io": "^4.8.1",
"socket.io-client": "^4.8.1",
```

### 2. socket/io.ts íŒŒì¼ ìƒì„± (ì´ˆê¸°í™”)

pages/api/socket í´ë”ë¥¼ ìƒì„±í•˜ì—¬ io.ts íŒŒì¼ì„ ìƒì„± í›„

ì´ˆê¸°í™” ì½”ë“œë¥¼ ì‘ì„±í•œë‹¤.

Socket.ioëŠ” ì‹¤ì‹œê°„ í†µì‹ ì„ ìœ„í•´ WebSocket í”„ë¡œí† ì½œì„ ì‚¬ìš©í•œë‹¤.

ì¦‰, ì¼ë°˜ì ì¸ HTTP ìš”ì²­ ë³¸ë¬¸ íŒŒì‹±(body parsing)ì´ í•„ìš”í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— bodyParserë¥¼ ë¹„í™œì„±í™” í•´ì¤€ë‹¤.

í˜„ì¬ HTTP ì„œë²„ì— Socket.ioê°€ ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸ í›„ ì´ˆê¸°í™” í•´ì¤€ë‹¤.

```tsx
//pages/api/socket/io.ts

import { Server as NetServer } from "http";
import { NextApiRequest } from "next";
import { Server as ServerIO } from "socket.io";

import { NextApiResponseServerIo } from "@/types";

// ê¸°ë³¸ Next.jsì˜ bodyParserë¥¼ ë¹„í™œì„±í™”
export const config = {
  api: {
    bodyParser: false
  }
};

const ioHandler = (req: NextApiRequest, res: NextApiResponseServerIo) => {
  // ì„œë²„ì— ì—°ê²°ë˜ì–´ ìˆì§€ ì•Šë‹¤ë©´ socket.io ì„œë²„ ì´ˆê¸°í™”
  if (!res.socket.server.io) {
    const path = "/api/socket/io"; // ì›¹ì†Œì¼“ ì—°ê²°ì„ ì²˜ë¦¬í•  ê²½ë¡œ
    const httpServer: NetServer = res.socket.server as any;
    const io = new ServerIO(httpServer, {
      path: path,
      //@ts-ignore
      addTrailingSlash: false // íƒ€ì… ì˜¤ë¥˜ ë°©ì§€
    });

    res.socket.server.io = io;
  }

  res.end(); // ì‘ë‹µ ì¢…ë£Œ
};

export default ioHandler;
```

- íƒ€ì… ì¶”ê°€

ê¸°ë³¸ `NextApiResponse`ëŠ” Socket.IO ê´€ë ¨ ì†ì„±ì„ í¬í•¨í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— íƒ€ì…ì„ í™•ì¥í•˜ì—¬ Socket.IO ì„œë²„ì™€ í†µí•©ëœ íƒ€ì…ì„ ëª…ì‹œì ìœ¼ë¡œ ì •ì˜í•˜ì—¬ ì‚¬ìš©í•œë‹¤.

```tsx
//types.ts

import { Server as NetServer, Socket } from "net";
import { NextApiResponse } from "next";
import { Server as SocketIOServer } from "socket.io";

export type NextApiResponseServerIo = NextApiResponse & {
  socket: Socket & {
    server: NetServer & {
      io: SocketIOServer;
    };
  };
};
```

### 3. Socket Provider êµ¬í˜„

---

```tsx
// components/providers/socket-provider.tsx

"use client";

import { createContext, useContext, useEffect, useState } from "react";

import { io as ClientIO } from "socket.io-client";

type SocketContextType = {
  socket: any | null;
  isConnected: boolean;
};

// SocketContext ìƒì„±
const SocketContext = createContext<SocketContextType>({
  socket: null,
  isConnected: false
});

// ì»¤ìŠ¤í…€ í›… useSocket
export const useSocket = () => {
  return useContext(SocketContext);
};

// SocketProvider ì»´í¬ë„ŒíŠ¸ ìƒì„±
export const SocketProvider = ({ children }: { children: React.ReactNode }) => {
  // ì—°ê²°ëœ **Socket.IO í´ë¼ì´ì–¸íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ì €ì¥**
  const [socket, setSocket] = useState(null);
  // í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ê°€ ì—°ê²°ëœ ìƒíƒœ ì €ì¥
  const [isConnected, setIsConnected] = useState(false);

  // Sokcet.IO ì´ˆê¸°í™”
  useEffect(() => {
    // Socket.IO ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
    const socketInstance = new (ClientIO as any)(
      process.env.NEXT_PUBLIC_SITE_URL!,
      {
        path: "/api/socket/io", // ì—”ë“œí¬ì¸íŠ¸ ì§€ì •
        addTrailingSlash: false
      }
    );

    // ì„œë²„ì™€ ì„±ê³µì ìœ¼ë¡œ ì—°ê²°ë˜ì—ˆì„ ë•Œ
    socketInstance.on("connect", () => {
      setIsConnected(true);
    });

    // ì„œë²„ì™€ ì—°ê²°ì´ ëŠì–´ì¡Œì„ ë•Œ
    socketInstance.on("disconnect", () => {
      setIsConnected(false);
    });

    setSocket(socketInstance);

    // ì–¸ë§ˆìš´íŠ¸ë  ë•Œ í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ ê°„ ì—°ê²°ì„ ì •ë¦¬
    return () => {
      socketInstance.disconnect();
    };
  }, []);

  return (
    <SocketContext.Provider value={{ socket, isConnected }}>
      {children}
    </SocketContext.Provider>
  );
};
```

- layout.tsxì— SocketProvider ì¶”ê°€í•˜ì—¬ ì „ì²´ì—ì„œ Socket ìƒíƒœë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •

```tsx
// app/layout.tsx

import { SocketProvider } from "@/components/providers/socket-provider";
...
	<SocketProvider>
		<ModalProvider />
		{children}
	</SocketProvider>
...

```

### 4. Socket Indicator êµ¬í˜„

**Socket.IO ì—°ê²° ìƒíƒœ**ë¥¼ ì‹œê°ì ìœ¼ë¡œ í‘œì‹œí•˜ê¸° ìœ„í•œ **`SocketIndicator`** ì»´í¬ë„ŒíŠ¸ë¥¼ êµ¬í˜„í•œë‹¤.

---

```tsx
// components/socket-indicator.tsx

"use client";

import { useSocket } from "./providers/socket-provider";
import { Badge } from "@/components/ui/badge";

export const SocketIndicator = () => {
  const { isConnected } = useSocket(); // ì†Œì¼“ ì—°ê²° ìƒíƒœ

  // ì—°ê²°ë˜ì–´ ìˆì§€ ì•Šë‹¤ë©´
  if (!isConnected) {
    return (
      <Badge variant="outline" className="bg-yellow-600 text-white border-none">
        Fallback: Polling every 1s
      </Badge>
    );
  }

  // ì—°ê²°ë˜ì–´ ìˆë‹¤ë©´
  return (
    <Badge variant="outline" className="bg-emerald-600 text-white border-none">
      Live: Real-time updates
    </Badge>
  );
};
```

- í—¤ë”ì— ì¶”ê°€í•˜ì—¬ í˜„ì¬ ì†Œì¼“ ì—°ê²° ìƒíƒœë¥¼ ë³´ì—¬ì¤€ë‹¤.

```tsx
// components/chat/chat-header.tsx

import { SocketIndicator } from "@/components/socket-indicator";
...
      <div className="ml-auto flex items-center">
        <SocketIndicator />
      </div>
...

```
