---
title: Socketì„ ì‚¬ìš©í•œ Read-Time ì±„íŒ… êµ¬í˜„í•˜ê¸° - (3) ì±„íŒ… ë©”ì‹œì§€ ì»´í¬ë„ŒíŠ¸ êµ¬í˜„í•˜ê¸°
date: 2024-11-26 08:25:00 +09:00
categories: [í”„ë¡ íŠ¸ì—”ë“œ, Next.js]
tags: [Next.js, Socket]
---

# ğŸ“¢ Socketì„ ì‚¬ìš©í•œ Real-Time ì±„íŒ… êµ¬í˜„í•˜ê¸° - (3) ì±„íŒ… ë©”ì‹œì§€ ì»´í¬ë„ŒíŠ¸ êµ¬í˜„í•˜ê¸°

> **ì´ì „ ê¸€ì—ì„œ í–ˆë˜ ì‘ì—…**
>
> - (1) Socket IO ì´ˆê¸° ì„¸íŒ…
> - (2) ì±„íŒ… ì…ë ¥ì°½ ë° ë©”ì‹œì§€ ì „ì†¡ API êµ¬í˜„

ì´ë²ˆ ê¸€ì—ì„œëŠ” ì‹¤ì œë¡œ **ì±„íŒ… ë©”ì‹œì§€ë“¤ì„ ë Œë”ë§**í•˜ëŠ” ì»´í¬ë„ŒíŠ¸ë¥¼ êµ¬í˜„í•œë‹¤.  
ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ë•Œ **í˜ì´ì§•ì„ ì ìš©í•˜ì—¬ ì„±ëŠ¥ì„ ìµœì í™”**í•˜ê³ ,  
ìƒˆë¡œìš´ ë©”ì‹œì§€ê°€ ì˜¬ ë•Œ **ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸**ë˜ëŠ” ê¸°ëŠ¥ë„ ì¶”ê°€í•  ê²ƒì´ë‹¤.

---

## 1ï¸âƒ£ ì±„íŒ… ë©”ì‹œì§€ API êµ¬í˜„

ì±„íŒ…ì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ ë¶€ë¶„ ì¤‘ í•˜ë‚˜ëŠ” **ë©”ì‹œì§€ ë°ì´í„°ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ë¶ˆëŸ¬ì˜¤ëŠ” ê²ƒ**ì´ë‹¤.  
ì´ë¥¼ ìœ„í•´ **í˜ì´ì§•(pagination)ê³¼ ë¬´í•œ ìŠ¤í¬ë¡¤ì„ ì§€ì›í•˜ëŠ” ë©”ì‹œì§€ API**ë¥¼ ë§Œë“¤ì—ˆë‹¤.

### 1-1. Messages API ìƒì„± (GET ìš”ì²­ ì²˜ë¦¬)

```tsx
// app/api/messages/route.ts

import { NextResponse } from "next/server";
import { currentProfile } from "@/lib/current-profile";
import { Message } from "@prisma/client";
import { db } from "@/lib/db";

// (1) í•œ ë²ˆì— ë¡œë“œí•  ë©”ì‹œì§€ ê°œìˆ˜ ì œí•œ
const MESSAGES_BATCH = 10;

export async function GET(req: Request) {
  try {
    const profile = await currentProfile();
    const { searchParams } = new URL(req.url);

    const cursor = searchParams.get("cursor"); // í˜ì´ì§• ê¸°ì¤€ì 
    const channelId = searchParams.get("channelId");

    if (!profile) {
      return new NextResponse("Unauthorized", { status: 401 });
    }

    if (!channelId) {
      return new NextResponse("Channel ID Missing", { status: 400 });
    }

    // (2) ë©”ì‹œì§€ ì¡°íšŒ (í˜ì´ì§• ì ìš©)
    let messages: Message[] = [];

    if (cursor) {
      messages = await db.message.findMany({
        take: MESSAGES_BATCH, // 10ê°œì”© ë¶ˆëŸ¬ì˜¤ê¸°
        skip: 1,
        cursor: { id: cursor },
        where: { channelId },
        include: {
          member: { include: { profile: true } }
        },
        orderBy: { createdAt: "desc" }
      });
    } else {
      messages = await db.message.findMany({
        take: MESSAGES_BATCH,
        where: { channelId },
        include: {
          member: { include: { profile: true } }
        },
        orderBy: { createdAt: "desc" }
      });
    }

    // (3) ë‹¤ìŒ í˜ì´ì§€ì˜ cursor ì„¤ì •
    let nextCursor = null;
    if (messages.length === MESSAGES_BATCH) {
      nextCursor = messages[MESSAGES_BATCH - 1].id;
    }

    return NextResponse.json({ items: messages, nextCursor });
  } catch (error) {
    console.log("[MESSAGES_GET]", error);
    return new NextResponse("Internal Error", { status: 500 });
  }
}
```

### âœ… API ë™ì‘ ë°©ì‹

1. **í•œ ë²ˆì— 10ê°œì”© ë©”ì‹œì§€ë¥¼ ê°€ì ¸ì˜¨ë‹¤.**
2. `cursor`ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í˜ì´ì§•ì„ ì²˜ë¦¬í•œë‹¤.
   - `cursor`ê°€ ì—†ìœ¼ë©´ ìµœì‹  ë©”ì‹œì§€ë¥¼ ê°€ì ¸ì˜¨ë‹¤.
   - `cursor`ê°€ ìˆìœ¼ë©´, í•´ë‹¹ ë©”ì‹œì§€ ì´í›„ì˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¨ë‹¤.
3. `nextCursor` ê°’ì„ ë°˜í™˜í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ì—ì„œ **ë¬´í•œ ìŠ¤í¬ë¡¤ì„ ì ìš©**í•  ìˆ˜ ìˆê²Œ í•œë‹¤.

---

## 2ï¸âƒ£ ì±„íŒ… ë©”ì‹œì§€ UI êµ¬í˜„

ì´ì œ ì‹¤ì œë¡œ **ì±„íŒ… ë©”ì‹œì§€ë“¤ì„ í™”ë©´ì— ë Œë”ë§**í•˜ëŠ” ì»´í¬ë„ŒíŠ¸ë¥¼ êµ¬í˜„í•œë‹¤.  
ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°, **ë¬´í•œ ìŠ¤í¬ë¡¤ ì ìš©**, **ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸** ë“±ì˜ ê¸°ëŠ¥ì´ í¬í•¨ëœë‹¤.

### 2-1. ì±„íŒ… ì‹œì‘ í™”ë©´ í‘œì‹œ

- ìƒˆë¡œìš´ ì±„ë„ì— ë“¤ì–´ì™”ì„ ë•Œ ê¸°ë³¸ì ìœ¼ë¡œ **í™˜ì˜ ë©”ì‹œì§€**ë¥¼ í‘œì‹œí•œë‹¤.
- ì±„ë„ì¸ì§€, ê°œì¸ ëŒ€í™”ì¸ì§€ì— ë”°ë¼ UIë¥¼ ë‹¤ë¥´ê²Œ êµ¬ì„±í•œë‹¤.

```tsx
// components/chat/chat-welcome.tsx

import { Hash } from "lucide-react";

interface ChatWelcomeProps {
  name: string;
  type: "channel" | "conversation";
}

export const ChatWelcome = ({ name, type }: ChatWelcomeProps) => {
  return (
    <div className="space-y-2 px-4 mb-4">
      {type === "channel" && (
        <div className="h-[75px] w-[75px] rounded-full bg-zinc-500 dark:bg-zinc-700 flex items-center justify-center">
          <Hash className="h-12 w-12 text-white" />
        </div>
      )}
      <p className="text-xl md:text-3xl font-bold">
        {type === "channel" ? "Welcome to #" : ""}
        {name}
      </p>
      <p className="text-zinc-600 dark:text-zinc-400 text-sm">
        {type === "channel"
          ? `This is the start of the ${name} channel.`
          : `This is the start of your conversation with ${name}.`}
      </p>
    </div>
  );
};
```

---

### 2-2. ì±„íŒ… ë©”ì‹œì§€ ì»´í¬ë„ŒíŠ¸ êµ¬í˜„

- **ë¬´í•œ ìŠ¤í¬ë¡¤**ì„ ì ìš©í•˜ì—¬ ì´ì „ ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆë„ë¡ í•œë‹¤.
- ë©”ì‹œì§€ë¥¼ **ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸**í•  ìˆ˜ ìˆë„ë¡ `useChatQuery`ë¥¼ ì‚¬ìš©í•œë‹¤.

```tsx
// components/chat/chat-messages.tsx

"use client";

import { Member, Message, Profile } from "@prisma/client";
import { Loader2, ServerCrash } from "lucide-react";
import { useChatQuery } from "@/hooks/use-chat-query";
import { ChatWelcome } from "@/components/chat/chat-welcome";
import { Fragment } from "react";

type MessageWithMemberWithProfile = Message & {
  member: Member & {
    profile: Profile;
  };
};

interface ChatMessagesProps {
  name: string;
  member: Member;
  chatId: string;
  apiUrl: string;
  socketUrl: string;
  socketQuery: Record<string, string>;
  paramKey: "channelId" | "conversationId";
  paramValue: string;
  type: "channel" | "conversation";
}

export const ChatMessages = ({
  name,
  member,
  chatId,
  apiUrl,
  socketUrl,
  socketQuery,
  paramKey,
  paramValue,
  type
}: ChatMessagesProps) => {
  const queryKey = `chat:${chatId}`;

  // (1) useChatQuery ê°€ì ¸ì˜¤ê¸° (ë¬´í•œ ìŠ¤í¬ë¡¤ & ì‹¤ì‹œê°„ ë©”ì‹œì§€ ì ìš©)
  const { data, fetchNextPage, hasNextPage, isFetchingNextPage, status } =
    useChatQuery({ queryKey, apiUrl, paramKey, paramValue });

  // (2) ë¡œë”© & ì—ëŸ¬ ì²˜ë¦¬
  if (status === "loading") {
    return (
      <div className="flex flex-col flex-1 justify-center items-center ">
        <Loader2 className="h-7 w-7 text-zinc-500 animate-spin my-4 " />
        <p className="text-xs text-zinc-500 dark:text-zinc-400">
          Loading messages...
        </p>
      </div>
    );
  }

  if (status === "error") {
    return (
      <div className="flex flex-col flex-1 justify-center items-center ">
        <ServerCrash className="h-7 w-7 text-zinc-500 my-4 " />
        <p className="text-xs text-zinc-500 dark:text-zinc-400">
          Something went wrong!
        </p>
      </div>
    );
  }

  // (3) ë©”ì‹œì§€ ë Œë”ë§
  return (
    <div className="flex-1 flex-col flex overflow-y-auto">
      <div className="flex-1" />
      <ChatWelcome name={name} type={type} />

      <div className="flex flex-col-reverse mt-auto">
        {data?.pages?.map((group, i) => (
          <Fragment key={i}>
            {group.items.map((message: MessageWithMemberWithProfile) => (
              <div key={message.id}>{message.content}</div>
            ))}
          </Fragment>
        ))}
      </div>
    </div>
  );
};
```

---

## âœ… ì •ë¦¬

- **ë©”ì‹œì§€ API**ë¥¼ ë§Œë“¤ì–´ í˜ì´ì§• ì²˜ë¦¬ ì ìš©
- **ë¬´í•œ ìŠ¤í¬ë¡¤ê³¼ ì‹¤ì‹œê°„ ë©”ì‹œì§€**ë¥¼ ì§€ì›í•˜ëŠ” ì±„íŒ… ì»´í¬ë„ŒíŠ¸ êµ¬í˜„
- ì±„íŒ… UIë¥¼ ê°œì„ í•˜ì—¬ **í™˜ì˜ ë©”ì‹œì§€** ë° **ë©”ì‹œì§€ ë¦¬ìŠ¤íŠ¸** ì¶”ê°€
