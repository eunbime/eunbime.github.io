---
title: Socketì„ ì‚¬ìš©í•œ Read-Time ì±„íŒ… êµ¬í˜„í•˜ê¸° - (1) Socket IO ì´ˆê¸° ì„¸íŒ…
date: 2024-11-21 07:20:30 +09:00
categories: [í”„ë¡ íŠ¸ì—”ë“œ, Next.js]
tags: [Next.js, Socket]
---

# ğŸ‘©â€ğŸ’» Socketì„ ì‚¬ìš©í•œ Real-Time ì±„íŒ… êµ¬í˜„í•˜ê¸°

ì‹¤ì‹œê°„ ì±„íŒ…ì„ êµ¬í˜„í•˜ê¸° ìœ„í•´ì„œëŠ” **WebSocket**ì„ í™œìš©í•´ì•¼ í•˜ë©°, ì´ë¥¼ ë³´ë‹¤ ì‰½ê²Œ ë‹¤ë£° ìˆ˜ ìˆë„ë¡ í•´ì£¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ **Socket.IO**ì´ë‹¤. ì´ë²ˆ ê¸€ì—ì„œëŠ” Next.jsì—ì„œ **Socket.IOë¥¼ í™œìš©í•˜ì—¬ ì‹¤ì‹œê°„ ì±„íŒ…ì„ êµ¬ì¶•í•˜ëŠ” ì´ˆê¸° ì„¤ì • ë°©ë²•**ì„ ë‹¤ë£¬ë‹¤.

<br/>

## 1ï¸âƒ£ Socket.IO ì´ˆê¸° ì„¸íŒ…

### 1. Socket.IO íŒ¨í‚¤ì§€ ì„¤ì¹˜

ë¨¼ì € ì‹¤ì‹œê°„ í†µì‹ ì„ ìœ„í•´ **Socket.IO íŒ¨í‚¤ì§€**ë¥¼ ì„¤ì¹˜í•œë‹¤.

```bash
npm install socket.io socket.io-client
```

ë˜ëŠ”

```json
"socket.io": "^4.8.1",
"socket.io-client": "^4.8.1"
```

### 2. Socket.IO ì„œë²„ ì„¤ì •

Next.jsì˜ API ë¼ìš°íŠ¸ë¥¼ í™œìš©í•˜ì—¬ **Socket.IO ì„œë²„ë¥¼ ì„¤ì •**í•œë‹¤. ë¨¼ì € `/pages/api/socket` í´ë”ë¥¼ ìƒì„±í•˜ê³ , `io.ts` íŒŒì¼ì„ ë§Œë“ ë‹¤.

#### `io.ts` - Socket.IO ì„œë²„ ì´ˆê¸°í™”

```tsx
// pages/api/socket/io.ts
import { Server as NetServer } from "http";
import { NextApiRequest } from "next";
import { Server as ServerIO } from "socket.io";
import { NextApiResponseServerIo } from "@/types";

// Next.js ê¸°ë³¸ bodyParser ë¹„í™œì„±í™”
export const config = {
  api: {
    bodyParser: false
  }
};

const ioHandler = (req: NextApiRequest, res: NextApiResponseServerIo) => {
  if (!res.socket.server.io) {
    const path = "/api/socket/io"; // WebSocket ì—°ê²° ê²½ë¡œ
    const httpServer: NetServer = res.socket.server as any;
    const io = new ServerIO(httpServer, {
      path: path,
      addTrailingSlash: false
    });

    res.socket.server.io = io;
  }
  res.end();
};

export default ioHandler;
```

#### `types.ts` - ì»¤ìŠ¤í…€ íƒ€ì… ì¶”ê°€

ê¸°ë³¸ Next.js `NextApiResponse`ëŠ” Socket.IO ì†ì„±ì„ í¬í•¨í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— í™•ì¥í•˜ì—¬ ì‚¬ìš©í•œë‹¤.

```tsx
// types.ts
import { Server as NetServer, Socket } from "net";
import { NextApiResponse } from "next";
import { Server as SocketIOServer } from "socket.io";

export type NextApiResponseServerIo = NextApiResponse & {
  socket: Socket & {
    server: NetServer & {
      io: SocketIOServer;
    };
  };
};
```

<br/>

### 3. Socket Provider êµ¬í˜„

Next.jsì—ì„œ `Socket.IO`ë¥¼ ì „ì—­ì ìœ¼ë¡œ ê´€ë¦¬í•˜ê¸° ìœ„í•´ **Context API**ë¥¼ í™œìš©í•˜ì—¬ **SocketProvider**ë¥¼ êµ¬í˜„í•œë‹¤.

#### `socket-provider.tsx` - Socket Provider ìƒì„±

```tsx
// components/providers/socket-provider.tsx
"use client";

import { createContext, useContext, useEffect, useState } from "react";
import { io as ClientIO } from "socket.io-client";

type SocketContextType = {
  socket: any | null;
  isConnected: boolean;
};

const SocketContext = createContext<SocketContextType>({
  socket: null,
  isConnected: false
});

export const useSocket = () => useContext(SocketContext);

export const SocketProvider = ({ children }: { children: React.ReactNode }) => {
  const [socket, setSocket] = useState(null);
  const [isConnected, setIsConnected] = useState(false);

  useEffect(() => {
    const socketInstance = new (ClientIO as any)(
      process.env.NEXT_PUBLIC_SITE_URL!,
      {
        path: "/api/socket/io",
        addTrailingSlash: false
      }
    );

    socketInstance.on("connect", () => setIsConnected(true));
    socketInstance.on("disconnect", () => setIsConnected(false));

    setSocket(socketInstance);

    return () => socketInstance.disconnect();
  }, []);

  return (
    <SocketContext.Provider value={{ socket, isConnected }}>
      {children}
    </SocketContext.Provider>
  );
};
```

#### `layout.tsx` - ì „ì—­ì ìœ¼ë¡œ SocketProvider ì¶”ê°€

```tsx
// app/layout.tsx
import { SocketProvider } from "@/components/providers/socket-provider";

export default function RootLayout({
  children
}: {
  children: React.ReactNode;
}) {
  return <SocketProvider>{children}</SocketProvider>;
}
```

<br/>

### 4. Socket ì—°ê²° ìƒíƒœ í‘œì‹œ (Indicator êµ¬í˜„)

**ì‹¤ì‹œê°„ ì—°ê²° ìƒíƒœ**ë¥¼ ì‹œê°ì ìœ¼ë¡œ í‘œì‹œí•˜ê¸° ìœ„í•´ `SocketIndicator` ì»´í¬ë„ŒíŠ¸ë¥¼ êµ¬í˜„í•œë‹¤.

#### `socket-indicator.tsx` - ì—°ê²° ìƒíƒœ UI ì¶”ê°€

```tsx
// components/socket-indicator.tsx
"use client";

import { useSocket } from "./providers/socket-provider";
import { Badge } from "@/components/ui/badge";

export const SocketIndicator = () => {
  const { isConnected } = useSocket();

  return (
    <Badge
      variant="outline"
      className={isConnected ? "bg-emerald-600" : "bg-yellow-600"}
    >
      {isConnected ? "Live: Real-time updates" : "Fallback: Polling every 1s"}
    </Badge>
  );
};
```

#### `chat-header.tsx` - ì±„íŒ… í—¤ë”ì— í‘œì‹œ

```tsx
// components/chat/chat-header.tsx
import { SocketIndicator } from "@/components/socket-indicator";
...
<div className="ml-auto flex items-center">
  <SocketIndicator />
</div>
...
```

<br/>

## âœ… ë§ˆë¬´ë¦¬

ì´ë²ˆ ê¸€ì—ì„œëŠ” **Next.jsì—ì„œ Socket.IOë¥¼ í™œìš©í•œ ì‹¤ì‹œê°„ ì±„íŒ… ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ê¸° ìœ„í•œ ì´ˆê¸° ì„¸íŒ…**ì„ ì§„í–‰í–ˆë‹¤.

âœ… `Socket.IO` ì„œë²„ë¥¼ API Routeë¡œ ì„¤ì •í•˜ê³ ,
âœ… `SocketProvider`ë¥¼ ë§Œë“¤ì–´ ì „ì—­ì ìœ¼ë¡œ ê´€ë¦¬í•˜ë©°,
âœ… ì‹¤ì‹œê°„ ì—°ê²° ìƒíƒœë¥¼ `SocketIndicator`ë¥¼ í†µí•´ í‘œì‹œí•˜ëŠ” êµ¬ì¡°ë¥¼ ê°–ì¶”ì—ˆë‹¤.
